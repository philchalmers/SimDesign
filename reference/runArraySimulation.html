<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Run a Monte Carlo simulation using array job submissions per condition — runArraySimulation • SimDesign</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Run a Monte Carlo simulation using array job submissions per condition — runArraySimulation"><meta name="description" content="This function has the same purpose as runSimulation, however
rather than evaluating each row in a design object (potentially with
parallel computing architecture) this function evaluates the simulation
per independent row condition. This is mainly useful when distributing the
jobs to HPC clusters where a job array number is available (e.g., via SLURM),
where the simulation results must be saved to independent files as they
complete. Use of expandDesign is useful for distributing replications
to different jobs, while genSeeds is required to ensure high-quality
random number generation across the array submissions. See the associated
vignette for a brief tutorial of this setup."><meta property="og:description" content="This function has the same purpose as runSimulation, however
rather than evaluating each row in a design object (potentially with
parallel computing architecture) this function evaluates the simulation
per independent row condition. This is mainly useful when distributing the
jobs to HPC clusters where a job array number is available (e.g., via SLURM),
where the simulation results must be saved to independent files as they
complete. Use of expandDesign is useful for distributing replications
to different jobs, while genSeeds is required to ensure high-quality
random number generation across the array submissions. See the associated
vignette for a brief tutorial of this setup."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SimDesign</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.19.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/Catch_errors.html">Managing warning and error messages</a></li>
    <li><a class="dropdown-item" href="../articles/Fixed_obj_fun.html">Exporting objects and functions from the workspace</a></li>
    <li><a class="dropdown-item" href="../articles/HPC-computing.html">Distributing jobs for high-performance computing (HPC) clusters (e.g., via Slurm)</a></li>
    <li><a class="dropdown-item" href="../articles/MultipleAnalyses.html">Multiple analysis functions</a></li>
    <li><a class="dropdown-item" href="../articles/Parallel-computing.html">Parallel computing information</a></li>
    <li><a class="dropdown-item" href="../articles/Saving-results.html">Saving simulation results and state</a></li>
    <li><a class="dropdown-item" href="../articles/SimDesign-intro.html">Introduction to the SimDesign package</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/philchalmers/SimDesign/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Run a Monte Carlo simulation using array job submissions per condition</h1>
      <small class="dont-index">Source: <a href="https://github.com/philchalmers/SimDesign/blob/main/R/runArraySimulation.R" class="external-link"><code>R/runArraySimulation.R</code></a></small>
      <div class="d-none name"><code>runArraySimulation.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function has the same purpose as <code><a href="runSimulation.html">runSimulation</a></code>, however
rather than evaluating each row in a <code>design</code> object (potentially with
parallel computing architecture) this function evaluates the simulation
per independent row condition. This is mainly useful when distributing the
jobs to HPC clusters where a job array number is available (e.g., via SLURM),
where the simulation results must be saved to independent files as they
complete. Use of <code><a href="expandDesign.html">expandDesign</a></code> is useful for distributing replications
to different jobs, while <code><a href="genSeeds.html">genSeeds</a></code> is required to ensure high-quality
random number generation across the array submissions. See the associated
vignette for a brief tutorial of this setup.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">runArraySimulation</span><span class="op">(</span></span>
<span>  <span class="va">design</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  <span class="va">replications</span>,</span>
<span>  <span class="va">iseed</span>,</span>
<span>  <span class="va">filename</span>,</span>
<span>  dirname <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  arrayID <span class="op">=</span> <span class="fu"><a href="getArrayID.html">getArrayID</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  array2row <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">arrayID</span><span class="op">)</span> <span class="va">arrayID</span>,</span>
<span>  addArrayInfo <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cl <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  ncores <span class="op">=</span> <span class="fu">parallelly</span><span class="fu">::</span><span class="fu"><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">availableCores</a></span><span class="op">(</span>omit <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>,</span>
<span>  save_details <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-design">design<a class="anchor" aria-label="anchor" href="#arg-design"></a></dt>
<dd><p>design object containing simulation conditions on a per row basis.
This function is design to submit each row as in independent job on a HPC cluster.
See <code><a href="runSimulation.html">runSimulation</a></code> for further details</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>additional arguments to be passed to <code><a href="runSimulation.html">runSimulation</a></code></p></dd>


<dt id="arg-replications">replications<a class="anchor" aria-label="anchor" href="#arg-replications"></a></dt>
<dd><p>number of independent replications to perform per
condition (i.e., each row in <code>design</code>). See <code><a href="runSimulation.html">runSimulation</a></code>
for further details</p></dd>


<dt id="arg-iseed">iseed<a class="anchor" aria-label="anchor" href="#arg-iseed"></a></dt>
<dd><p>initial seed to be passed to <code><a href="genSeeds.html">genSeeds</a></code>'s argument
of the same name, along with the supplied <code>arrayID</code></p></dd>


<dt id="arg-filename">filename<a class="anchor" aria-label="anchor" href="#arg-filename"></a></dt>
<dd><p>file name to save simulation files to (does not need to
specify extension). However, the array ID will be appended to each
<code>filename</code>. For example, if
<code>filename = 'mysim'</code> then files stored will be <code>'mysim-1.rds'</code>,
<code>'mysim-2.rds'</code>, and so on for each row ID in <code>design</code></p></dd>


<dt id="arg-dirname">dirname<a class="anchor" aria-label="anchor" href="#arg-dirname"></a></dt>
<dd><p>directory to save the files associated with <code>filename</code>
to. If omitted the files will be stored in the same working directory
where the script was submitted</p></dd>


<dt id="arg-arrayid">arrayID<a class="anchor" aria-label="anchor" href="#arg-arrayid"></a></dt>
<dd><p>array identifier from the scheduler. Must be a number between
1 and <code>nrow(design)</code>. If not specified then <code><a href="getArrayID.html">getArrayID</a></code> will
be called automatically, which assumes the environmental variables are available
according the SLURM scheduler</p></dd>


<dt id="arg-array-row">array2row<a class="anchor" aria-label="anchor" href="#arg-array-row"></a></dt>
<dd><p>user defined function with the single argument <code>arrayID</code>.
  Used to convert the detected <code>arrayID</code>
  into a suitable row index in the <code>design</code> object input. By default
  each <code>arrayID</code> is associated with its respective row in <code>design</code>.</p>
<p>For example, if each <code>arrayID</code> should evaluate 10 rows in
  the <code>design</code> object then the function
  <code>function(arrayID){1:10 + 10 * (arrayID-1)}</code> can be passed to <code>array2row</code></p></dd>


<dt id="arg-addarrayinfo">addArrayInfo<a class="anchor" aria-label="anchor" href="#arg-addarrayinfo"></a></dt>
<dd><p>logical; should the array ID and original design row number
be added to the <code>SimResults(...)</code> output?</p></dd>


<dt id="arg-parallel">parallel<a class="anchor" aria-label="anchor" href="#arg-parallel"></a></dt>
<dd><p>logical; use parallel computations via the a "SOCK" cluster?
Only useful when the instruction shell file requires more than 1 core
(number of cores detected via <code>ncores</code>). For this application
the random seeds further distributed using <code><a href="https://rdrr.io/r/parallel/RngStream.html" class="external-link">nextRNGSubStream</a></code></p></dd>


<dt id="arg-cl">cl<a class="anchor" aria-label="anchor" href="#arg-cl"></a></dt>
<dd><p>cluster definition. If omitted a "SOCK" cluster will be defined</p></dd>


<dt id="arg-ncores">ncores<a class="anchor" aria-label="anchor" href="#arg-ncores"></a></dt>
<dd><p>number of cores to use when <code>parallel=TRUE</code>. Note that
the default uses 1 minus the number of available cores, therefore this
will only be useful when <code>ncores &gt; 2</code> as defined in the shell instruction
file</p></dd>


<dt id="arg-save-details">save_details<a class="anchor" aria-label="anchor" href="#arg-save-details"></a></dt>
<dd><p>optional list of extra file saving details.
See <code><a href="runSimulation.html">runSimulation</a></code></p></dd>


<dt id="arg-control">control<a class="anchor" aria-label="anchor" href="#arg-control"></a></dt>
<dd><p>control list passed to <code><a href="runSimulation.html">runSimulation</a></code>.
  In addition to the original <code>control</code> elements two
  additional arguments have been added:
  <code>max_time</code> and <code>max_RAM</code>, both of which as specified as
  character vectors with one element.</p>
<p><code>max_time</code> specifies the maximum time allowed for a
  single simulation condition to execute (default does not set
  any time limits), and is formatted according to the specification in
  <code><a href="timeFormater.html">timeFormater</a></code>. This is primarily useful when the HPC cluster
  will time out after some known elapsed time.
  In general, this input should be set to somewhere around
  80-90<!-- % of the true termination time so that any evaluations completed -->
  before the cluster is terminated can be saved. Default applies no time limit</p>
<p>Similarly, <code>max_RAM</code> controls the
  (approximate) maximum size that the simulation storage objects can grow
  before RAM becomes an issue. This can be specified either in terms of megabytes
  (MB), gigabytes (GB), or terabytes (TB). For example, <code>max_RAM = "4GB"</code> indicates that
  if the simulation storage objects are larger than 4GB then the workflow
  will terminate early, returning only the successful results up to this point).
  Useful for larger HPC cluster jobs with RAM constraints that could terminate abruptly.
  As a rule of thumb this should be set to around 90<!-- % of the maximum possible storage -->
  available. Default applies no memory limit</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>logical; pass a verbose flag to <code><a href="runSimulation.html">runSimulation</a></code>.
Unlike <code><a href="runSimulation.html">runSimulation</a></code> this is set to FALSE during interactive
sessions, though set to TRUE when non-interactive and information about the
session itself should be stored (e.g., in SLURM <code>.out</code> files)</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Due to the nature of how the replication are split it is important that
the L'Ecuyer-CMRG (2002) method of random seeds is used across all
array ID submissions (cf. <code><a href="runSimulation.html">runSimulation</a></code>'s <code>parallel</code>
approach, which uses this method to distribute random seeds within
each isolated condition rather than between all conditions). As such, this
function requires the seeds to be generated using
<code><a href="genSeeds.html">genSeeds</a></code> with the <code>iseed</code> and <code>arrayID</code>
inputs to ensure that each job is analyzing a high-quality
set of random numbers via L'Ecuyer-CMRG's (2002) method, incremented using
<code><a href="https://rdrr.io/r/parallel/RngStream.html" class="external-link">nextRNGStream</a></code>.</p>
<p>Additionally, for timed simulations on HPC clusters it is also recommended to pass a
<code>control = list(max_time)</code> value to avoid discarding
conditions that require more than the specified time in the shell script.
The <code>max_time</code> value should be less than the maximum time allocated
on the HPC cluster (e.g., approximately 90<!-- % of this time or less, though -->
depends on how long, and how variable, each replication is). Simulations with missing
replications should submit a new set of jobs at a later time
to collect the missing information.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Chalmers, R. P., &amp; Adkins, M. C.  (2020). Writing Effective and Reliable Monte Carlo Simulations
with the SimDesign Package. <code>The Quantitative Methods for Psychology, 16</code>(4), 248-280.
<a href="https://doi.org/10.20982/tqmp.16.4.p248" class="external-link">doi:10.20982/tqmp.16.4.p248</a></p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="runSimulation.html">runSimulation</a></code>, <code><a href="expandDesign.html">expandDesign</a></code>,
  <code><a href="genSeeds.html">genSeeds</a></code>, <code><a href="SimCheck.html">SimCheck</a></code>,
  <code><a href="SimCollect.html">SimCollect</a></code>, <code><a href="getArrayID.html">getArrayID</a></code></p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Phil Chalmers <a href="mailto:rphilip.chalmers@gmail.com">rphilip.chalmers@gmail.com</a></p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://philchalmers.github.io/SimDesign/">SimDesign</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">Design</span> <span class="op">&lt;-</span> <span class="fu"><a href="createDesign.html">createDesign</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">Generate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">condition</span>, <span class="va">fixed_objects</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">condition</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">10</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="co"># distributed N(10, 5)</span></span></span>
<span class="r-in"><span>    <span class="va">dat</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">Analyse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">condition</span>, <span class="va">dat</span>, <span class="va">fixed_objects</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="va">ret</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>mean<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, median<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="co"># mean/median of sample data</span></span></span>
<span class="r-in"><span>    <span class="va">ret</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">Summarise</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">condition</span>, <span class="va">results</span>, <span class="va">fixed_objects</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># define initial seed (do this only once to keep it constant!)</span></span></span>
<span class="r-in"><span><span class="co"># iseed &lt;- genSeeds()</span></span></span>
<span class="r-in"><span><span class="va">iseed</span> <span class="op">&lt;-</span> <span class="fl">554184288</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### On cluster submission, the active array ID is obtained via getArrayID(),</span></span></span>
<span class="r-in"><span><span class="co">###   and therefore should be used in real SLURM submissions</span></span></span>
<span class="r-in"><span><span class="va">arrayID</span> <span class="op">&lt;-</span> <span class="fu"><a href="getArrayID.html">getArrayID</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'slurm'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># However, the following example arrayID is set to</span></span></span>
<span class="r-in"><span><span class="co">#  the first row only for testing purposes</span></span></span>
<span class="r-in"><span><span class="va">arrayID</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># run the simulation (results not caught on job submission, only files saved)</span></span></span>
<span class="r-in"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">runArraySimulation</span><span class="op">(</span>design<span class="op">=</span><span class="va">Design</span>, replications<span class="op">=</span><span class="fl">50</span>,</span></span>
<span class="r-in"><span>                      generate<span class="op">=</span><span class="va">Generate</span>, analyse<span class="op">=</span><span class="va">Analyse</span>,</span></span>
<span class="r-in"><span>                      summarise<span class="op">=</span><span class="va">Summarise</span>, arrayID<span class="op">=</span><span class="va">arrayID</span>,</span></span>
<span class="r-in"><span>                      iseed<span class="op">=</span><span class="va">iseed</span>, filename<span class="op">=</span><span class="st">'mysim'</span><span class="op">)</span> <span class="co"># saved as 'mysim-1.rds'</span></span></span>
<span class="r-in"><span><span class="va">res</span></span></span>
<span class="r-in"><span><span class="fu"><a href="SimResults.html">SimResults</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="co"># condition and replication count stored</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># same, but evaluated with multiple cores</span></span></span>
<span class="r-in"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">runArraySimulation</span><span class="op">(</span>design<span class="op">=</span><span class="va">Design</span>, replications<span class="op">=</span><span class="fl">50</span>,</span></span>
<span class="r-in"><span>                      generate<span class="op">=</span><span class="va">Generate</span>, analyse<span class="op">=</span><span class="va">Analyse</span>,</span></span>
<span class="r-in"><span>                      summarise<span class="op">=</span><span class="va">Summarise</span>, arrayID<span class="op">=</span><span class="va">arrayID</span>,</span></span>
<span class="r-in"><span>                      parallel<span class="op">=</span><span class="cn">TRUE</span>, ncores<span class="op">=</span><span class="fl">3</span>,</span></span>
<span class="r-in"><span>                      iseed<span class="op">=</span><span class="va">iseed</span>, filename<span class="op">=</span><span class="st">'myparsim'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">res</span></span></span>
<span class="r-in"><span><span class="fu"><a href="SimResults.html">SimResults</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="co"># condition and replication count stored</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="SimClean.html">SimClean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'mysim-1.rds'</span>, <span class="st">'myparsim-1.rds'</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">########################</span></span></span>
<span class="r-in"><span><span class="co"># Same submission job as above, however split the replications over multiple</span></span></span>
<span class="r-in"><span><span class="co"># evaluations and combine when complete</span></span></span>
<span class="r-in"><span><span class="va">Design5</span> <span class="op">&lt;-</span> <span class="fu"><a href="expandDesign.html">expandDesign</a></span><span class="op">(</span><span class="va">Design</span>, <span class="fl">5</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">Design5</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># iseed &lt;- genSeeds()</span></span></span>
<span class="r-in"><span><span class="va">iseed</span> <span class="op">&lt;-</span> <span class="fl">554184288</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># arrayID &lt;- getArrayID(type = 'slurm')</span></span></span>
<span class="r-in"><span><span class="va">arrayID</span> <span class="op">&lt;-</span> <span class="fl">14L</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># run the simulation (replications reduced per row, but same in total)</span></span></span>
<span class="r-in"><span><span class="fu">runArraySimulation</span><span class="op">(</span>design<span class="op">=</span><span class="va">Design5</span>, replications<span class="op">=</span><span class="fl">10</span>,</span></span>
<span class="r-in"><span>                   generate<span class="op">=</span><span class="va">Generate</span>, analyse<span class="op">=</span><span class="va">Analyse</span>,</span></span>
<span class="r-in"><span>                   summarise<span class="op">=</span><span class="va">Summarise</span>, iseed<span class="op">=</span><span class="va">iseed</span>,</span></span>
<span class="r-in"><span>                   filename<span class="op">=</span><span class="st">'mylongsim'</span>, arrayID<span class="op">=</span><span class="va">arrayID</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">'mylongsim-14.rds'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">res</span></span></span>
<span class="r-in"><span><span class="fu"><a href="SimResults.html">SimResults</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="co"># condition and replication count stored</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="SimClean.html">SimClean</a></span><span class="op">(</span><span class="st">'mylongsim-14.rds'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">###</span></span></span>
<span class="r-in"><span><span class="co"># Emulate the arrayID distribution, storing all results in a 'sim/' folder</span></span></span>
<span class="r-in"><span><span class="co"># (if 'sim/' does not exist in runArraySimulation() it will be</span></span></span>
<span class="r-in"><span><span class="co"># created automatically)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">'sim/'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Emulate distribution to nrow(Design5) = 15 independent job arrays</span></span></span>
<span class="r-in"><span><span class="co">##  (just used for presentation purposes on local computer)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Design5</span><span class="op">)</span>, \<span class="op">(</span><span class="va">arrayID</span><span class="op">)</span></span></span>
<span class="r-in"><span>     <span class="fu">runArraySimulation</span><span class="op">(</span>design<span class="op">=</span><span class="va">Design5</span>, replications<span class="op">=</span><span class="fl">10</span>,</span></span>
<span class="r-in"><span>          generate<span class="op">=</span><span class="va">Generate</span>, analyse<span class="op">=</span><span class="va">Analyse</span>,</span></span>
<span class="r-in"><span>          summarise<span class="op">=</span><span class="va">Summarise</span>, iseed<span class="op">=</span><span class="va">iseed</span>, arrayID<span class="op">=</span><span class="va">arrayID</span>,</span></span>
<span class="r-in"><span>          filename<span class="op">=</span><span class="st">'condition'</span>, dirname<span class="op">=</span><span class="st">'sim'</span>, <span class="co"># files: "sim/condition-#.rds"</span></span></span>
<span class="r-in"><span>          control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>max_time<span class="op">=</span><span class="st">"04:00:00"</span>, max_RAM<span class="op">=</span><span class="st">"4GB"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#  If necessary, conditions above will manually terminate before</span></span></span>
<span class="r-in"><span><span class="co">#  4 hours and 4GB of RAM are used, returning any</span></span></span>
<span class="r-in"><span><span class="co">#  successfully completed results before the HPC session times</span></span></span>
<span class="r-in"><span><span class="co">#  out (provided .slurm script specified more than 4 hours)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># list saved files</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="st">'sim/'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># check that all files saved (warnings will be raised if missing files)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="SimCheck.html">SimCheck</a></span><span class="op">(</span><span class="st">'sim/'</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">condition14</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">'sim/condition-14.rds'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">condition14</span></span></span>
<span class="r-in"><span><span class="fu"><a href="SimResults.html">SimResults</a></span><span class="op">(</span><span class="va">condition14</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># aggregate simulation results into single file</span></span></span>
<span class="r-in"><span><span class="va">final</span> <span class="op">&lt;-</span> <span class="fu"><a href="SimCollect.html">SimCollect</a></span><span class="op">(</span><span class="st">'sim/'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">final</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># clean simulation directory</span></span></span>
<span class="r-in"><span><span class="fu"><a href="SimClean.html">SimClean</a></span><span class="op">(</span>dirs<span class="op">=</span><span class="st">'sim/'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">############</span></span></span>
<span class="r-in"><span><span class="co"># same as above, however passing different amounts of information depending</span></span></span>
<span class="r-in"><span><span class="co"># on the array ID</span></span></span>
<span class="r-in"><span><span class="va">array2row</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">arrayID</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">arrayID</span>,</span></span>
<span class="r-in"><span>    <span class="st">"1"</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span>,</span></span>
<span class="r-in"><span>    <span class="st">"2"</span><span class="op">=</span><span class="fl">9</span><span class="op">:</span><span class="fl">14</span>,</span></span>
<span class="r-in"><span>    <span class="st">"3"</span><span class="op">=</span><span class="fl">15</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># arrayID 1 does row 1 though 8, arrayID 2 does 9 to 14</span></span></span>
<span class="r-in"><span><span class="fu">array2row</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">array2row</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">array2row</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>  <span class="co"># arrayID 3 does 15 only</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># emulate remote array distribution with only 3 arrays</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, \<span class="op">(</span><span class="va">arrayID</span><span class="op">)</span></span></span>
<span class="r-in"><span>     <span class="fu">runArraySimulation</span><span class="op">(</span>design<span class="op">=</span><span class="va">Design5</span>, replications<span class="op">=</span><span class="fl">10</span>,</span></span>
<span class="r-in"><span>          generate<span class="op">=</span><span class="va">Generate</span>, analyse<span class="op">=</span><span class="va">Analyse</span>,</span></span>
<span class="r-in"><span>          summarise<span class="op">=</span><span class="va">Summarise</span>, iseed<span class="op">=</span><span class="va">iseed</span>, arrayID<span class="op">=</span><span class="va">arrayID</span>,</span></span>
<span class="r-in"><span>          filename<span class="op">=</span><span class="st">'condition'</span>, dirname<span class="op">=</span><span class="st">'sim'</span>, array2row<span class="op">=</span><span class="va">array2row</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># list saved files</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="st">'sim/'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># note that all row conditions are still stored separately, though note that</span></span></span>
<span class="r-in"><span><span class="co">#  arrayID is now 2 instead</span></span></span>
<span class="r-in"><span><span class="va">condition14</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">'sim/condition-14.rds'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">condition14</span></span></span>
<span class="r-in"><span><span class="fu"><a href="SimResults.html">SimResults</a></span><span class="op">(</span><span class="va">condition14</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># aggregate simulation results into single file</span></span></span>
<span class="r-in"><span><span class="va">final</span> <span class="op">&lt;-</span> <span class="fu"><a href="SimCollect.html">SimCollect</a></span><span class="op">(</span><span class="st">'sim/'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">final</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># clean simulation directory</span></span></span>
<span class="r-in"><span><span class="fu"><a href="SimClean.html">SimClean</a></span><span class="op">(</span>dirs<span class="op">=</span><span class="st">'sim/'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Phil Chalmers.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer></div>





  </body></html>

